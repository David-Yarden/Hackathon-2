<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Budget Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body {
      background: linear-gradient(135deg, #4e54c8, #8f94fb);
      font-family: 'Segoe UI', sans-serif;
      min-height: 100vh;
      color: #333;
      transition: background 0.5s, color 0.5s;
    }
    .navbar {
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(6px);
      transition: background 0.5s;
    }
    .navbar-brand {
      color: white !important;
      font-weight: bold;
      font-size: 1.3em;
    }
    .content {
      max-width: 900px;
      margin: 60px auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
      padding: 40px;
      transition: background 0.5s, color 0.5s;
    }
    .card {
      border-radius: 16px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    .income { color: #27ae60; font-weight: bold; }
    .expense { color: #e74c3c; font-weight: bold; }
    .balance {
      font-size: 1.6em;
      font-weight: 700;
      color: #4e54c8;
    }
    .delete-btn {
      border: none;
      background: #e74c3c;
      color: white;
      border-radius: 6px;
      padding: 4px 10px;
      font-size: 0.85em;
    }
    .delete-btn:hover { background: #c0392b; }
    .add-form input, .add-form select { border-radius: 8px; }

    /* ðŸŒ™ Mode sombre */
    .dark-mode {
      background: linear-gradient(135deg, #1e1e2f, #3a3a5a);
      color: #f1f1f1;
    }
    .dark-mode .content {
      background-color: #2b2b3d;
      color: #f1f1f1;
    }
    .dark-mode .card {
      background-color: #3c3c54;
      color: white;
    }
    .dark-mode .navbar {
      background: rgba(255,255,255,0.1);
    }
    .dark-mode .btn-outline-dark {
      color: white;
      border-color: white;
    }
    .dark-mode .btn-outline-dark:hover {
      background-color: white;
      color: black;
    }
  </style>
</head>
<body>

  <nav class="navbar navbar-dark px-3">
    <div class="container-fluid d-flex justify-content-between align-items-center">
      <a class="navbar-brand" href="/">ðŸ’¸ Budget Tracker</a>
      <div class="d-flex align-items-center gap-3">
        <button id="exportBtn" class="btn btn-outline-light btn-sm">ðŸ“„ Export PDF</button>
        <div class="form-check form-switch text-white mb-0">
          <input class="form-check-input" type="checkbox" id="themeSwitch">
          <label class="form-check-label" for="themeSwitch">ðŸŒ™</label>
        </div>
      </div>
    </div>
  </nav>

  <div class="content">
    <h1 class="text-center mb-4">Budget Dashboard</h1>

    <div class="row text-center mb-5">
      <div class="col-md-4">
        <div class="card p-3 bg-light">
          <h6>Total Income</h6>
          <p class="income fs-4" id="incomeValue">+<%= totalIncome %></p>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card p-3 bg-light">
          <h6>Total Expense</h6>
          <p class="expense fs-4" id="expenseValue">-<%= totalExpense %></p>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card p-3 bg-light">
          <h6>Balance</h6>
          <p class="balance" id="balanceValue"><%= balance %></p>
        </div>
      </div>
    </div>

    <div class="card p-4 mb-4">
      <h4 class="mb-3">Add Transaction</h4>
      <form class="add-form row g-2" action="/transactions" method="POST">
        <div class="col-md-5">
          <input type="text" name="title" placeholder="Title" class="form-control" required>
        </div>
        <div class="col-md-3">
          <input type="number" step="0.01" name="amount" placeholder="Amount" class="form-control" required>
        </div>
        <div class="col-md-2">
          <select name="type" class="form-select">
            <option value="income">Income</option>
            <option value="expense">Expense</option>
          </select>
        </div>
        <div class="col-md-2">
          <button type="submit" class="btn btn-primary w-100">Add</button>
        </div>
      </form>
    </div>

    <div class="card p-4 mb-4">
      <h4 class="mb-3">Transactions</h4>
      <% if (transactions.length === 0) { %>
        <p class="text-muted text-center">No transactions yet.</p>
      <% } else { %>
        <ul class="list-group">
          <% transactions.forEach(t => { %>
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <strong><%= t.title %></strong> :
                <span class="<%= t.type === 'income' ? 'income' : 'expense' %>">
                  <%= t.type === 'income' ? '+' : '-' %><%= t.amount %>
                </span>
                <small class="text-muted d-block">
                  <%= new Date(t.created_at).toLocaleString() %>
                </small>
              </div>
              <form action="/transactions/delete/<%= t.id %>" method="POST">
                <button type="submit" class="delete-btn">âœ– Supprimer</button>
              </form>
            </li>
          <% }) %>
        </ul>
      <% } %>
    </div>

    <div class="card p-4">
      <h4 class="mb-3 text-center">ðŸ“Š Income vs Expense</h4>
      <canvas id="budgetChart"></canvas>
    </div>
  </div>

  <script>
    // ðŸŒ™ Mode sombre
    const switcher = document.getElementById('themeSwitch');
    switcher.addEventListener('change', () => {
      document.body.classList.toggle('dark-mode');
    });

    // ðŸ“„ Export PDF
    document.getElementById('exportBtn').addEventListener('click', () => {
      html2canvas(document.querySelector('.content')).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
        const width = 210;
        const height = (canvas.height * width) / canvas.width;
        pdf.addImage(imgData, 'PNG', 0, 0, width, height);
        pdf.save('budget-report.pdf');
      });
    });

    // ðŸ“Š Chart.js Donut
    const ctx = document.getElementById('budgetChart');
    const chart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Income', 'Expense'],
        datasets: [{
          data: [<%- totalIncome %>, <%- totalExpense %>],
          backgroundColor: ['#27ae60', '#e74c3c'],
          borderWidth: 2,
          hoverOffset: 12
        }]
      },
      options: {
        plugins: {
          legend: { position: 'bottom' }
        }
      }
    });
  </script>

</body>
</html>
